<div class="card my-5">
  <div class="card-body">
    <!-- Barra de pesquisa responsiva -->
    <div class="search-container">
      <table class="w-100">
        <tr>
          <td id="searchBar_td">
            <div style="display: flex; gap: 12px; align-items: center; width: 100%;">
              <input type="text"
                     placeholder="Nome do produto..."
                     class="searchBar_input btn-outline-secondary"
                     [(ngModel)]="searchValue" name="searchBarNome" (input)="onSearchChanged()"
                     style="flex: 1 1 33%; min-width: 0;"/>
              <input type="text"
                     placeholder="Nome do fornecedor..."
                     class="searchBar_input btn-outline-secondary"
                     [(ngModel)]="searchNomeFornecedor" name="searchBarNomeFornecedor" (input)="onSearchChanged()"
                     style="flex: 1 1 33%; min-width: 0;"/>
              <input type="number"
                     placeholder="Valor unitário..."
                     class="searchBar_input btn-outline-secondary"
                     [(ngModel)]="searchValorInicial" name="searchBarValorInicial" (input)="onSearchChanged()"
                     style="flex: 1 1 33%; min-width: 0;"/>
            </div>
          </td>
          <td>
            <!-- Removido o combobox de tipo de pesquisa -->
          </td>
          <td>
            
          </td>
        </tr>
      </table>
    </div>

    <!-- Container da tabela com scroll horizontal -->
    <div class="div-tabela" *ngIf="listaDeProdutos; else loadingProdutosTpl">
      <table class="table table-bordered table-striped">
        <thead class="thead-dark">
        <tr>
          <th colspan="12" class="text-center">Produtos</th>
        </tr>
        <tr>
          <th class="text-center checkbox-col" style="width: 40px;"><input type="checkbox" [checked]="isTodosProdutosSelecionados()" (change)="onToggleSelecionarTodosProdutos($event)"></th>
          <th class="text-center coluna_id" style="width: 80px; min-width: 60px; max-width: 100px;">ID</th>
          <th class="text-left coluna_nome" style="width: 220px; min-width: 140px; max-width: 380px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Nome</th>
          <th class="text-left coluna_fornecedor" style="width: 400px; min-width: 200px; max-width: 600px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Fornecedor</th>
          <th class="text-left coluna_descricao">Descrição</th>
          <th class="text-center coluna_qtde" style="width: 60px; min-width: 40px; max-width: 80px;">Qtde</th>
          <th class="text-center coluna_valor" style="width: 200px; min-width: 100px; max-width: 250px;">Valor unit</th>
          <th class="text-center coluna_promocao" style="width: 100px; min-width: 60px; max-width: 120px;">Promoção</th>
          <th class="text-center coluna_valor_desc" style="width: 200px; min-width: 100px; max-width: 250px;">Vl qtd desc</th>
          <th class="text-center coluna_valor_total" style="width: 200px; min-width: 100px; max-width: 250px;">Valor total</th>
          <th class="text-center coluna_acao" style="width: 80px; min-width: 60px; max-width: 100px;"></th>
          <th class="text-center coluna_acao" style="width: 80px; min-width: 60px; max-width: 100px;"></th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let produto of listaDeProdutos" [ngClass]="{'sem-estoque': (produto.quantia || 0) === 0}">
          <td class="text-center checkbox-col"><input type="checkbox" [checked]="selecionadosProdutoIds.has(produto.id || -1)" (change)="onToggleCheckboxProduto(produto, $event)"></td>
          <td class="text-center coluna_id" style="width: 80px; min-width: 60px; max-width: 100px;">{{ produto.id }}</td>
          <td class="text-left coluna_nome" style="width: 220px; min-width: 140px; max-width: 380px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
            <div class="stat-item">
              <span class="stat-label passar_mouse" (mouseenter)="mostrarImgPopup(produto)" (mouseleave)="esconderImgPopup()">
                {{ produto.nome }}
              </span>
              <div *ngIf="popUpVisivel" class="img-popup">
                <div class="image-container" [ngClass]="{'no-image': !imgBase64}">
                  <img *ngIf="imgBase64" [src]="'data:image/jpeg;base64,' + imgBase64" alt="Imagem do produto"/>
                </div>
              </div>
            </div>
          </td>
          <td class="text-left coluna_fornecedor" style="width: 400px; min-width: 200px; max-width: 600px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ produto.fornecedor?.nome }}</td>
          <td class="text-left coluna_descricao"><span class="texto-ellipsis">{{ produto.descricao }}</span></td>
          <td class="text-center coluna_qtde" style="width: 60px; min-width: 40px; max-width: 80px;">{{ produto.quantia }}</td>
          <td class="text-center coluna_valor" style="width: 200px; min-width: 100px; max-width: 250px;">{{ formatarValor(produto.valorInicial) }}</td>
          <td class="text-center coluna_promocao" style="width: 100px; min-width: 60px; max-width: 120px;">
            <img
              [src]="produto.promocao ? '/bolinha_verde.png' : '/bolinha_vermelha.png'"
              [alt]="produto.promocao ? 'Promoção Ativa' : 'Promoção Inativa'"
              width="25"
              height="25">
          </td>
          <td class="text-center coluna_valor_desc" style="width: 200px; min-width: 100px; max-width: 250px;">{{ formatarValor(produto.valorTotalDesc) }}</td>
          <td class="text-center coluna_valor_total" style="width: 200px; min-width: 100px; max-width: 250px;">{{ formatarValor(produto.somaTotalValores) }}</td>
          <td class="text-center coluna_acao" style="width: 80px; min-width: 60px; max-width: 100px;">
            <button type="button" class="btn btn-info full-width-btn" id="btn_editar" (click)="atualizarProduto(modalEditar, produto.id ?? 0, produto)">✎</button>
          </td>
          <td class="text-center coluna_acao" style="width: 80px; min-width: 60px; max-width: 100px;">
            <button type="button" class="btn btn-danger full-width-btn" id="btn_excluir" (click)="abrirModalConfirmarExclusaoProduto(produto)">X</button>
          </td>
        </tr>

        <!-- Label que exibe a variável do produto mais caro -->
        <tr>
          <td colspan="12" class="text-left">
            <div class="stats-container-vertical">
              <span class="stat-row stat-label-container stat-value-container">
                <span class="stat-text">PRODUTO MAIS CARO - ID:</span>
                <span class="stat-variable">{{ stringProdutoMaisCaro }}</span>
                <span class="stat-text"> | MÉDIA DE PREÇO -</span>
                <span class="stat-variable">{{ formatarValor(mediaPreco) }}</span>
              </span>
            </div>
          </td>
        </tr>
        <tr>
          <td colspan="12" class="text-left">
            <div class="info-container">
              <div class="info-item">
                <span class="info-label">Vl qtd desc:</span>
                <span class="info-text">este é o valor da soma total da quantia de produtos com desconto, caso esteja em promoção.</span>
              </div>
              <div class="info-divider">|</div>
              <div class="info-item">
                <span class="info-label">Valor total:</span>
                <span class="info-text">este é o valor total do produto, com frete e com desconto, caso tenha frete e caso esteja em promoção.</span>
              </div>
            </div>
          </td>
        </tr>
        <tr>
          <td colspan="12">
            <div class="d-flex align-items-center" style="gap: 8px;">
              <button class="btn btn-sm btn-danger" [disabled]="selecionadosProdutoIds.size === 0" (click)="abrirModalExcluirSelecionadosProdutos()">Excluir selecionados</button>
              <button class="btn bg-primary-subtle fw-bold btn-atualizar-lista" (click)="atualizarLista()" role="button">Atualizar</button>
            </div>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <!-- Paginação responsiva -->
    <div class="pagination-container">
      <mat-paginator [length]="totalRecords" 
                     [pageSize]="pageSize" 
                     [pageIndex]="currentPage" 
                     (page)="trocarPagina($event)"
                     [pageSizeOptions]="[5, 10, 25, 50]">
      </mat-paginator>
    </div>
  </div>
</div>

<ng-template #loadingProdutosTpl>
  <div class="d-flex justify-content-center align-items-center" style="min-height: 120px;">
    <span class="spinner-border me-2" role="status" aria-hidden="true"></span>
    <span>Carregando produtos...</span>
  </div>
</ng-template>

<!-- Modal de confirmação para exclusão múltipla (estilo idêntico ao PDV) -->
<ng-template #modalConfirmDeleteMultiProdutos let-modal>
  <div class="modal-header py-2 lp-modal">
    <h6 class="modal-title">Confirmar exclusão</h6>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body lp-modal">
    Tem certeza que deseja excluir os produtos selecionados?
  </div>
  <div class="modal-footer py-2 lp-modal">
    <button class="btn btn-sm btn-secondary" (click)="modal.dismiss()">Cancelar</button>
    <button class="btn btn-sm btn-danger" (click)="confirmarExclusaoSelecionadosProdutos(modal)">Excluir</button>
  </div>
  </ng-template>

<!-- Modal de confirmação para exclusão individual (estilo idêntico ao PDV) -->
<ng-template #modalConfirmDeleteProduto let-modal>
  <div class="modal-header py-2 lp-modal">
    <h6 class="modal-title">Confirmar exclusão</h6>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body lp-modal">
    Tem certeza que deseja excluir este produto?
  </div>
  <div class="modal-footer py-2 lp-modal">
    <button class="btn btn-sm btn-secondary" (click)="modal.dismiss()">Cancelar</button>
    <button class="btn btn-sm btn-danger" (click)="confirmarExclusaoProduto(modal)">Excluir</button>
  </div>
  </ng-template>

<!--######## INICIO DO MODAL DE EDIÇÃO DE PRODUTO ######## -->

<ng-template #modalEditar let-modal>
  <div class="modal-container">
    <div class="modal-header">
      <h5 class="modal-title">Atualizar produto</h5>
      <img ngSrc="/codigo_barras.png" height="60" width="60" class="img-right"/>
    </div>
    
    <div class="modal-body">
      <p class="produto-info">ID <b>{{ produtoAtualizar.id }}</b> | Informações do produto <b>{{ produtoAtualizar.nome }}</b></p>
      
      <form (ngSubmit)="onSubmitSalvar(modal)" #produtoForm="ngForm" class="produto-form">
        
        <!-- Campo ID oculto para manter o binding -->
        <input type="hidden" [(ngModel)]="produtoAtualizar.id" name="idProduto" #id="ngModel">

        <!-- Informações Básicas -->
        <div class="form-section">
          <h6 class="section-title">Informações Básicas</h6>
          <div class="form-row">
            <div class="form-group">
              <label for="nome" class="required">Nome:</label>
              <input type="text" [(ngModel)]="produtoAtualizar.nome"
                     class="form-control"
                     id="nome"
                     name="nomeProduto"
                     placeholder="Insira o nome do produto"
                     required #nome="ngModel"
                     maxlength="100"
                     [ngClass]="{'is-invalid': nome.invalid && nome.touched}">
              <div *ngIf="nome.invalid && nome.touched" class="invalid-feedback">
                O nome do produto é obrigatório.
              </div>
            </div>
            <div class="form-group">
              <label for="descricao">Descrição:</label>
              <input type="text" [(ngModel)]="produtoAtualizar.descricao"
                     class="form-control"
                     id="descricao"
                     name="descricaoProduto"
                     placeholder="Insira a descrição do produto"
                     maxlength="100">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="fornecedor" class="required">
                Fornecedor:
              </label>
              <select [(ngModel)]="fornecedorSelecionado"
                      class="form-control"
                      id="fornecedor"
                      name="fornecedorProduto"
                      required #fornecedor="ngModel"
                      (ngModelChange)="onFornecedorChange($event)">
                <option *ngFor="let fornecedor of fornecedores" [ngValue]="fornecedor">
                  ID {{fornecedor.id}} - {{fornecedor.nome}}
                </option>
              </select>
            </div>
          </div>
        </div>

        <!-- Valores e Quantidade -->
        <div class="form-section">
          <h6 class="section-title">Valores e Quantidade</h6>
          <button type="button" 
                  class="btn-calcular-mini" 
                  (click)="calcularValores(produtoAtualizar)"
                  title="Calcular valores">
            ↻
          </button>
          <div class="form-row">
            <div class="form-group">
              <label for="valorInicial">Valor unitário:</label>
              <div class="input-with-display">
                <input type="number" [(ngModel)]="produtoAtualizar.valorInicial"
                       class="form-control"
                       id="valorInicial"
                       name="valorInicialProduto"
                       required #valorInicial="ngModel"
                       min="0"
                       max="2000000000"
                       [ngClass]="{'is-invalid': valorInicial.value > 2000000000}"
                       (ngModelChange)="onValorInicialChangeAtualizar($event)">
                <div class="valor-display">{{produtoAtualizar.valorInicial | currency : 'BRL'}}</div>
              </div>
              <div *ngIf="valorInicial.value > 2000000000" class="validation-message">
                O valor unitário não pode ser maior que 2.000.000.000
              </div>
              <input type="number" [(ngModel)]="produtoAtualizar.valor"
                     class="form-control hidden-input"
                     id="valor"
                     name="valorProduto"
                     required #valor="ngModel"
                     max="2000000000">
            </div>
            <div class="form-group">
              <label for="quantidade">Quantidade:</label>
              <div class="input-with-display">
                <input type="number" [(ngModel)]="produtoAtualizar.quantia"
                       class="form-control"
                       id="quantidade"
                       name="quantidadeProduto"
                       required #quantidade="ngModel"
                       min="0"
                       max="1000000"
                       [ngClass]="{'is-invalid': quantidade.value > 1000000}">
                <div class="valor-display valor-quantidade">{{produtoAtualizar.valor | currency : 'BRL'}}</div>
              </div>
              <div *ngIf="quantidade.value > 1000000" class="validation-message">
                A quantidade não pode ser maior que 1.000.000
              </div>
            </div>
          </div>
        </div>

        <!-- Promoção e Desconto -->
        <div class="form-section">
          <h6 class="section-title">Promoção e Desconto</h6>
          <button type="button" 
                  class="btn-calcular-mini" 
                  (click)="calcularValores(produtoAtualizar)"
                  title="Calcular valores">
            ↻
          </button>
          <div class="form-row">
            <div class="form-group">
              <label for="promocao">Promoção:</label>
              <select [(ngModel)]="produtoAtualizar.promocao"
                      class="form-control"
                      id="promocao"
                      name="promocaoProduto"
                      required #promocao="ngModel"
                      (ngModelChange)="selecionarPromocao($event)">
                <option [ngValue]="true">Sim</option>
                <option [ngValue]="false">Não</option>
              </select>
            </div>
            <div class="form-group">
              <label for="valorDesconto">Desconto:</label>
              <div class="input-with-display">
                <input type="text" [(ngModel)]="produtoAtualizar.valorDesconto"
                       class="form-control"
                       id="valorDesconto"
                       name="valorDescontoProduto"
                       required #valorDesconto="ngModel"
                       appPorcentagemMask
                       [disabled]="!produtoAtualizar.promocao">
                <div class="valor-display">{{produtoAtualizar.valorTotalDesc | currency : 'BRL'}}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Frete -->
        <div class="form-section">
          <h6 class="section-title">Frete</h6>
          <button type="button" 
                  class="btn-calcular-mini" 
                  (click)="calcularValores(produtoAtualizar)"
                  title="Calcular valores">
            ↻
          </button>
          <div class="form-row">
            <div class="form-group">
              <label for="freteAtivo">Frete ativo:</label>
              <select [(ngModel)]="produtoAtualizar.freteAtivo"
                      class="form-control"
                      id="freteAtivo"
                      name="freteAtivoProduto"
                      required #freteAtivo="ngModel"
                      (ngModelChange)="ativarFrete($event)">
                <option [ngValue]="true">Sim</option>
                <option [ngValue]="false">Não</option>
              </select>
            </div>
            <div class="form-group">
              <label for="frete">Valor do frete:</label>
              <div class="input-with-display">
                <input type="number" [(ngModel)]="produtoAtualizar.frete"
                       class="form-control"
                       id="frete"
                       name="freteProduto"
                       required #frete="ngModel"
                       min="0"
                       max="2000000000"
                       [ngClass]="{'is-invalid': frete.value > 2000000000}"
                       [disabled]="!produtoAtualizar.freteAtivo">
                <div *ngIf="frete.value > 2000000000" class="invalid-feedback">
                  O valor do frete não pode ser maior que 2.000.000.000
                </div>
                <div class="valor-display">{{produtoAtualizar.frete | currency : 'BRL'}}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Totais -->
        <div class="form-section">
          <h6 class="section-title">Totais</h6>
          <div class="totals-container">
            <div class="total-item">
              <label>Valor total com frete:</label>
              <input type="number" [(ngModel)]="produtoAtualizar.valorTotalFrete"
                     class="form-control hidden-input"
                     id="valorTotalFrete"
                     name="valorTotalFreteProduto"
                     required #valorTotalFrete="ngModel"
                     max="2000000000"
                     [disabled]="true">
              <div class="valor-display-large">{{produtoAtualizar.valorTotalFrete | currency : 'BRL'}}</div>
            </div>
            
            <div class="total-item valor-total-principal">
              <label class="total-label"><b>VALOR TOTAL:</b></label>
              <input type="number" [(ngModel)]="produtoAtualizar.somaTotalValores"
                     class="form-control hidden-input"
                     id="somaTotalValores"
                     name="somaTotalValoresProduto"
                     required #somaTotalValores="ngModel"
                     max="2000000000">
              <div class="valor-display-final">{{produtoAtualizar.somaTotalValores | currency : 'BRL'}}</div>
            </div>
          </div>
        </div>

        <!-- Upload de Foto -->
        <div class="form-section">
          <h6 class="section-title">Foto do Produto</h6>
          <div class="file-upload-container-compact">
            <label for="foto_produto" class="file-label">Selecionar foto: <small style="color:#b02a37">Max. 20MB • Somente .jpg / .png</small></label>
            <input id="foto_produto" 
                   type="file" 
                   class="form-control-file-compact"
                   (change)="onFileChange($event)" 
                   [disabled]="isMobileOrTablet">
          </div>
        </div>

        <!-- Botões de Ação -->
        <div class="form-section">
          <div class="button-container">
            <button type="button" 
                    class="btn btn-calcular" 
                    (click)="calcularValores(produtoAtualizar)">
              Calcular valores
            </button>
            <button type="submit" 
                    class="btn btn-salvar" 
                    [disabled]="!produtoForm.form.valid" 
                    (click)="abrirTelaAviso(modalSalvouProduto)">
              Salvar produto
            </button>
          </div>
        </div>

      </form>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary btn-fechar" (click)="modal.close()">
        Fechar
      </button>
    </div>
  </div>
</ng-template>

<!--######## FIM DO MODAL DE EDIÇÃO DE PRODUTO ######## -->

<!-- Modal de aviso (arquivo inválido) -->
<ng-template #modalAvisoArquivo let-modal>
  <div class="modal-header">
    <h6 class="modal-title">Aviso</h6>
  </div>
  <div class="modal-body">
    <p>{{ avisoTextoModal }}</p>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary btn-sm" (click)="modal.close()">Ok</button>
  </div>
</ng-template>

<!-- Janela (modal) que abre ao clicar no botão Excluir -->
<ng-template #modalMsgExcluir let-modal>
  <div class="modal-header">
    <h5 class="modal-title">
      Sucesso!
    </h5>
    <img ngSrc="/codigo_barras.png" height="60" width="60" class="img-right"/>
  </div>
  <div class="modal-body">
    <p>Produto <b>{{ produtoExcluido.nome }}</b> excluído.</p>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.close()">Fechar</button>
  </div>
</ng-template>

<!-- Janela (modal) de AVISO que abre depois de Salvar as atualizações de um produto -->
<ng-template #modalSalvouProduto let-modal>
  <div class="modal-header">
    <h4 class="modal-title">
      AVISO!
    </h4>
    <img ngSrc="/codigo_barras.png" height="60" width="60" class="img-right"/>
  </div>
  <div class="modal-body">
    <a style="font-size: 15px;">Informações atualizadas!</a><br>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.close()">Fechar</button>
  </div>
</ng-template>

<!-- Modal de erro ao tentar excluir produto com histórico -->
<ng-template #modalErroExcluirHistorico let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Atenção</h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.close()"></button>
  </div>
  <div class="modal-body">
    <p>Impossível excluir pois existe <b>histórico de {{ tipoHistoricoModal }}</b> relacionado.</p>
    <div *ngIf="(produtosRelacionadosErro.length || 0) > 0; else unicoProdutoRelacionado">
      <p>Produtos relacionados:</p>
      <ul style="margin:0; padding-left: 18px;">
        <li *ngFor="let p of produtosRelacionadosErro">ID {{ p.id }} - {{ p.nome }}</li>
      </ul>
    </div>
    <ng-template #unicoProdutoRelacionado>
      <p>
        Produto: <b>ID {{ produtoExcluido ? produtoExcluido.id : (produtoAtualizar ? produtoAtualizar.id : '-') }}</b> -
        <b>{{ produtoExcluido ? produtoExcluido.nome : (produtoAtualizar ? produtoAtualizar.nome : '-') }}</b>
      </p>
    </ng-template>
    <p class="mt-2">Exclua o histórico primeiro para poder excluir o produto.</p>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.close()">Fechar</button>
  </div>
</ng-template>
