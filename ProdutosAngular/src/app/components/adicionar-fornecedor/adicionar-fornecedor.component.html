<div class="card my-5">
  <div class="card-body">
    <!-- Linha de controle - Radio buttons, botões e mensagens -->
    <div class="row mb-3 justify-content-center">
      <div class="col-md-2">
        <label class="fw-bold">Informar CNPJ?</label><br>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="informarCNPJ" id="informarCNPJSim" 
                 [(ngModel)]="informarCNPJ" [value]="true" (change)="onInformarCNPJChange()">
          <label class="form-check-label" for="informarCNPJSim">SIM</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="informarCNPJ" id="informarCNPJNao" 
                 [(ngModel)]="informarCNPJ" [value]="false" (change)="onInformarCNPJChange()">
          <label class="form-check-label" for="informarCNPJNao">NÃO</label>
        </div>
      </div>
      <div class="col-md-6">
        <button type="button" 
                class="btn btn-secondary me-2 style-btn-form" 
                (click)="buscarEmpresaPorCNPJ(cnpjEmpresa)"
                [disabled]="isLoadingCNPJ || !informarCNPJ">
          <span *ngIf="!isLoadingCNPJ">Buscar Empresa</span>
          <span *ngIf="isLoadingCNPJ" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          <span *ngIf="isLoadingCNPJ">Buscando...</span>
        </button>
        <button type="button" 
                class="btn btn-warning me-2 style-btn-form" 
                (click)="limparFormularioCNPJ()"
                [disabled]="!informarCNPJ">
          Limpar Campos
        </button>
        <button type="button" 
                class="btn bg-primary-subtle fw-bold style-btn-form" 
                (click)="cadastrarCNPJ()">
          Próximo
        </button>
      </div>
      <div class="col-md-4 d-flex align-items-center">
        <small class="text-muted">
          <span *ngIf="fornecedorCadastradoComSucesso" class="text-success">
            <i class="bi bi-check-circle-fill"></i> Fornecedor cadastrado com sucesso!
          </span>
          <span *ngIf="informarCNPJ && cnpjBuscado && !fornecedorCadastradoComSucesso" class="text-success">
            <i class="bi bi-check-circle-fill"></i> Dados carregados
          </span>
          <span *ngIf="informarCNPJ && !cnpjBuscado && !fornecedorCadastradoComSucesso" class="text-info">
            <i class="bi bi-info-circle-fill"></i> Busque por um CNPJ em "Buscar Empresa"
          </span>
          <span *ngIf="!informarCNPJ && !fornecedorCadastradoComSucesso" class="text-info">
            <i class="bi bi-info-circle-fill"></i> CNPJ não informado
          </span>
        </small>
      </div>
    </div>

    <!-- Mensagem quando não informar CNPJ -->
    <div *ngIf="!informarCNPJ" class="alert alert-info">
      <p>Você optou por não informar os dados do CNPJ.</p>
    </div>

    <!-- Mensagem quando CNPJ foi cadastrado com sucesso -->
    <div *ngIf="cnpjCadastradoComSucesso && informarCNPJ && !formularioCNPJVisivel" class="alert alert-success">
      <p>Dados do CNPJ cadastrados com sucesso.</p>
    </div>

    <!-- Campos relacionados ao CNPJ -->
    <div *ngIf="informarCNPJ && formularioCNPJVisivel">
      <table class="table table-bordered" style="width: 100%; table-layout: fixed;">
        <thead>
          <tr>
            <th colspan="6" class="text-center">Dados da Empresa (CNPJ)</th>
          </tr>
        </thead>
        <tbody>
          <!-- Linha 1: CNPJ -->
          <tr>
            <td style="width: 16%;">
              <label for="cnpjEmpresa">CNPJ:</label>
            </td>
            <td colspan="5" style="width: 84%;">
              <input type="text" [(ngModel)]="cnpjEmpresa"
                     class="form-control"
                     id="cnpjEmpresa"
                     name="cnpjEmpresa"
                     placeholder="00.000.000/0000-00"
                     mask="00.000.000/0000-00"
                     [showMaskTyped]="true"
                     [disabled]="!informarCNPJ"
                     required
                     maxlength="100">
            </td>
          </tr>

          <!-- Campos que dependem do dadosEmpresa -->
          <ng-container *ngIf="dadosEmpresa">
            <!-- Linha 2: Razão Social e Nome Fantasia -->
            <tr>
              <td style="width: 16%;">
                <label for="razaoSocial">Razão Social:</label>
              </td>
              <td style="width: 24%;">
                <input type="text" [ngModel]="dadosEmpresa.razaoSocial"
                       class="form-control"
                       id="razaoSocial"
                       name="razaoSocial"
                       maxlength="100">
              </td>
              <td style="width: 12%;">
                <label for="nomeFantasia">Nome Fantasia:</label>
              </td>
              <td colspan="3" style="width: 48%;">
                <input type="text" [ngModel]="dadosEmpresa.nomeFantasia"
                       class="form-control"
                       id="nomeFantasia"
                       name="nomeFantasia"
                       maxlength="100">
              </td>
            </tr>

            <!-- Linha 3: CNAE Fiscal e Natureza Jurídica -->
            <tr>
              <td style="width: 16%;">
                <label for="cnaeFiscal">CNAE Fiscal:</label>
              </td>
              <td style="width: 24%;">
                <input type="text" [(ngModel)]="dadosEmpresa.cnaeFiscal"
                       class="form-control"
                       id="cnaeFiscal"
                       name="cnaeFiscal"
                       maxlength="100">
              </td>
              <td style="width: 12%;">
                <label for="naturezaJuridica">Natureza Jurídica:</label>
              </td>
              <td colspan="3" style="width: 48%;">
                <input type="text" [(ngModel)]="dadosEmpresa.descricaoNaturezaJuridica"
                       class="form-control"
                       id="naturezaJuridica"
                       name="naturezaJuridica"
                       maxlength="100">
              </td>
            </tr>

            <!-- Linha 4: Situação Cadastral e Data Situação -->
            <tr>
              <td style="width: 16%;">
                <label for="situacaoCadastral">Situação Cadastral:</label>
              </td>
              <td style="width: 24%;">
                <input type="text" [(ngModel)]="dadosEmpresa.situacaoCadastral"
                       class="form-control"
                       id="situacaoCadastral"
                       name="situacaoCadastral"
                       maxlength="100">
              </td>
              <td style="width: 12%;">
                <label for="dataSituacao">Data Situação:</label>
              </td>
              <td colspan="3" style="width: 48%;">
                <input type="text" [(ngModel)]="dadosEmpresa.dataSituacaoCadastral"
                       class="form-control"
                       id="dataSituacao"
                       name="dataSituacao"
                       maxlength="100">
              </td>
            </tr>

            <!-- Linha 5: Data Início Atividade e Porte -->
            <tr>
              <td style="width: 16%;">
                <label for="dataInicioAtividade">Data Início Atividade:</label>
              </td>
              <td style="width: 24%;">
                <input type="text" [(ngModel)]="dadosEmpresa.dataInicioAtividade"
                       class="form-control"
                       id="dataInicioAtividade"
                       name="dataInicioAtividade"
                       maxlength="100">
              </td>
              <td style="width: 12%;">
                <label for="porte">Porte:</label>
              </td>
              <td colspan="3" style="width: 48%;">
                <input type="text" [(ngModel)]="dadosEmpresa.porte"
                       class="form-control"
                       id="porte"
                       name="porte"
                       maxlength="100">
              </td>
            </tr>

            <!-- Linha 6: Capital Social -->
            <tr>
              <td style="width: 16%;">
                <label for="capitalSocial">Capital Social:</label>
              </td>
              <td colspan="5" style="width: 84%;">
                <input type="text" [(ngModel)]="dadosEmpresa.capitalSocial"
                       class="form-control"
                       id="capitalSocial"
                       name="capitalSocial"
                       maxlength="100">
              </td>
            </tr>

            <!-- Linha 7: Endereço - Logradouro e Número -->
            <tr>
              <td style="width: 16%;">
                <label for="logradouroEmpresa">Logradouro:</label>
              </td>
              <td style="width: 24%;">
                <input type="text" [(ngModel)]="dadosEmpresa.logradouro"
                       class="form-control"
                       id="logradouroEmpresa"
                       name="logradouroEmpresa"
                       maxlength="100">
              </td>
              <td style="width: 12%;">
                <label for="numeroEmpresa">Número:</label>
              </td>
              <td colspan="3" style="width: 48%;">
                <input type="text" [(ngModel)]="dadosEmpresa.numero"
                       class="form-control"
                       id="numeroEmpresa"
                       name="numeroEmpresa"
                       maxlength="100">
              </td>
            </tr>

            <!-- Linha 8: Endereço - Complemento e Bairro -->
            <tr>
              <td style="width: 16%;">
                <label for="complementoEmpresa">Complemento:</label>
              </td>
              <td style="width: 24%;">
                <input type="text" [(ngModel)]="dadosEmpresa.complemento"
                       class="form-control"
                       id="complementoEmpresa"
                       name="complementoEmpresa"
                       maxlength="100">
              </td>
              <td style="width: 12%;">
                <label for="bairroEmpresa">Bairro:</label>
              </td>
              <td colspan="3" style="width: 48%;">
                <input type="text" [(ngModel)]="dadosEmpresa.bairro"
                       class="form-control"
                       id="bairroEmpresa"
                       name="bairroEmpresa"
                       maxlength="100">
              </td>
            </tr>

            <!-- Linha 9: Endereço - CEP, Município e UF -->
            <tr>
              <td style="width: 16%;">
                <label for="cepEmpresa">CEP:</label>
              </td>
              <td style="width: 24%;">
                <input type="text" [(ngModel)]="dadosEmpresa.cep"
                       class="form-control"
                       id="cepEmpresa"
                       name="cepEmpresa"
                       maxlength="100">
              </td>
              <td style="width: 12%;">
                <label for="municipioEmpresa">Município:</label>
              </td>
              <td style="width: 16%;">
                <input type="text" [(ngModel)]="dadosEmpresa.municipio"
                       class="form-control"
                       id="municipioEmpresa"
                       name="municipioEmpresa"
                       maxlength="100">
              </td>
              <td style="width: 12%;">
                <label for="ufEmpresa">UF:</label>
              </td>
              <td style="width: 20%;">
                <input type="text" [(ngModel)]="dadosEmpresa.uf"
                       class="form-control"
                       id="ufEmpresa"
                       name="ufEmpresa"
                       maxlength="100">
              </td>
            </tr>

            <!-- Linha 10: País -->
            <tr>
              <td style="width: 16%;">
                <label for="paisEmpresa">País:</label>
              </td>
              <td colspan="5" style="width: 84%;">
                <input type="text" [(ngModel)]="dadosEmpresa.pais"
                       class="form-control"
                       id="paisEmpresa"
                       name="paisEmpresa"
                       maxlength="100">
              </td>
            </tr>

            <!-- Linha 11: Telefones -->
            <tr>
              <td style="width: 16%;">
                <label for="telefone1">Telefone 1:</label>
              </td>
              <td style="width: 24%;">
                <input type="text" [(ngModel)]="dadosEmpresa.telefone1"
                       class="form-control"
                       id="telefone1"
                       name="telefone1"
                       maxlength="100">
              </td>
              <td style="width: 12%;">
                <label for="telefone2">Telefone 2:</label>
              </td>
              <td colspan="3" style="width: 48%;">
                <input type="text" [(ngModel)]="dadosEmpresa.telefone2"
                       class="form-control"
                       id="telefone2"
                       name="telefone2"
                       maxlength="100">
              </td>
            </tr>

            <!-- Linha 12: Email -->
            <tr>
              <td style="width: 16%;">
                <label for="emailEmpresa">Email:</label>
              </td>
              <td colspan="5" style="width: 84%;">
                <input type="text" [(ngModel)]="dadosEmpresa.email"
                       class="form-control"
                       id="emailEmpresa"
                       name="emailEmpresa"
                       maxlength="100">
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="card my-5">
  <div class="card-body">
    <!-- Linha de controle para o formulário de fornecedor -->
    <div class="row mb-3 justify-content-center" *ngIf="formularioFornecedorHabilitado">
      <div class="col-md-6">
        <button type="button" 
                class="btn btn-secondary me-2 style-btn-form" 
                (click)="buscarEnderecoPorCep(endereco.cep)"
                [disabled]="isLoading">
          <span *ngIf="!isLoading">Buscar CEP</span>
          <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          <span *ngIf="isLoading">Buscando...</span>
        </button>
        <button type="button" 
                class="btn btn-warning me-2 style-btn-form" 
                (click)="limparFormularioFornecedor()">
          Limpar Campos
        </button>
      </div>
      <div class="col-md-6 d-flex align-items-center">
        <small class="text-muted">
          <span *ngIf="cepBuscado" class="text-success">
            <i class="bi bi-check-circle-fill"></i> Endereço carregado
          </span>
          <span *ngIf="!cepBuscado" class="text-info">
            <i class="bi bi-info-circle-fill"></i> Busque por um CEP em "Buscar CEP"
          </span>
        </small>
      </div>
    </div>

    <div class="div-tabela">
      

    <!-- INÍCIO FORMULÁRIO DE CADASTRO DE FORNECEDOR -->
    <form (ngSubmit)="onSubmit()" #fornecedorForm="ngForm" [class.disabled-form]="!formularioFornecedorHabilitado">
      <div class="div-tabela">
        <table class="table table-bordered" style="width: 100%; table-layout: fixed;" [class.disabled-table]="!formularioFornecedorHabilitado">
          <thead>
          <tr>
            <th colspan="6" class="text-center">Cadastrar um novo fornecedor</th>
          </tr>
          </thead>
          <tbody>
          <!-- Linha 1: Nome do Fornecedor, CEP e botões -->
          <tr>
            <td style="width: 16%;">
              <span style="color: red">* </span>
              <label for="nomeFornecedor" class="required">Nome do Fornecedor:</label>
            </td>
            <td style="width: 24%;">
              <input type="text" [(ngModel)]="nomeFornecedor"
                     class="form-control"
                     id="nomeFornecedor"
                     name="nomeFornecedor"
                     placeholder="Insira o nome do fornecedor."
                     required
                     #nomeFornecedorInput="ngModel"
                     [ngClass]="{'is-invalid': nomeFornecedorInput.invalid && nomeFornecedorInput.touched}"
                     maxlength="100">
              <div *ngIf="nomeFornecedorInput.invalid && nomeFornecedorInput.touched" class="invalid-feedback">
                O nome do fornecedor é obrigatório.
              </div>
            </td>
            <td style="width: 12%;">
              <span style="color: red">* </span>
              <label for="cep" class="required">CEP:</label>
            </td>
            <td style="width: 16%;">
              <input type="text" [(ngModel)]="endereco.cep"
                class="form-control"
                id="cep"
                name="cep"
                mask="00000-000"
                [showMaskTyped]="true"
                placeholder="00000-000"
                required
                #cepInput="ngModel"
                [ngClass]="{'is-invalid': cepInput.invalid && cepInput.touched}"
              />
              <div *ngIf="cepInput.invalid && cepInput.touched" class="invalid-feedback">
                O CEP é obrigatório.
              </div>
            </td>
            <td colspan="2" style="width: 32%;">
              <!-- Botões removidos - agora estão na linha de controle acima -->
            </td>
          </tr>

          <!-- Linha 2: Logradouro, Nº Residência, Complemento -->
          <tr>
            <td style="width: 16%;">
              <label for="logradouro">Logradouro:</label>
            </td>
            <td style="width: 24%;">
              <input type="text" [(ngModel)]="endereco.logradouro"
                     class="form-control"
                     id="logradouro"
                     name="logradouroFornecedor"
                     maxlength="100">
            </td>
            <td style="width: 12%;">
              <label for="nrResidenciaFornecedor">Nº Residência:</label>
            </td>
            <td style="width: 16%;">
              <input type="text" [(ngModel)]="nrResidenciaFornecedor"
                     class="form-control"
                     id="nrResidenciaFornecedor"
                     name="nrResidenciaFornecedor"
                     placeholder="Número"
                     maxlength="10">
            </td>
            <td style="width: 12%;">
              <label for="complemento">Complemento:</label>
            </td>
            <td style="width: 20%;">
              <input type="text" [(ngModel)]="endereco.complemento"
                     class="form-control"
                     id="complemento"
                     name="complementoFornecedor"
                     maxlength="100">
            </td>
          </tr>

          <!-- Linha 3: Unidade e Bairro -->
          <tr>
            <td style="width: 16%;">
              <label for="unidade">Unidade:</label>
            </td>
            <td style="width: 24%;">
              <input type="text" [(ngModel)]="endereco.unidade"
                     class="form-control"
                     id="unidade"
                     name="unidadeFornecedor"
                     maxlength="100">
            </td>
            <td style="width: 12%;">
              <label for="bairro">Bairro:</label>
            </td>
            <td colspan="3" style="width: 48%;">
              <input type="text" [(ngModel)]="endereco.bairro"
                     class="form-control"
                     id="bairro"
                     name="bairroFornecedor"
                     maxlength="100">
            </td>
          </tr>

          <!-- Linha 4: Cidade, UF, Estado -->
          <tr>
            <td style="width: 16%;">
              <label for="localidade">Cidade:</label>
            </td>
            <td style="width: 24%;">
              <input type="text" [(ngModel)]="endereco.localidade"
                     class="form-control"
                     id="localidade"
                     name="localidadeFornecedor"
                     maxlength="100">
            </td>
            <td style="width: 12%;">
              <label for="uf">UF:</label>
            </td>
            <td style="width: 16%;">
              <input type="text" [(ngModel)]="endereco.uf"
                     class="form-control"
                     id="uf"
                     name="ufFornecedor"
                     maxlength="100">
            </td>
            <td style="width: 12%;">
              <label for="estado">Estado:</label>
            </td>
            <td style="width: 20%;">
              <input type="text" [(ngModel)]="endereco.estado"
                     class="form-control"
                     id="estado"
                     name="estadoFornecedor"
                     maxlength="100">
            </td>
          </tr>

          <!-- Linha 5: Região, IBGE, GIA -->
          <tr>
            <td style="width: 16%;">
              <label for="regiao">Região:</label>
            </td>
            <td style="width: 24%;">
              <input type="text" [(ngModel)]="endereco.regiao"
                     class="form-control"
                     id="regiao"
                     name="regiaoFornecedor"
                     maxlength="100">
            </td>
            <td style="width: 12%;">
              <label for="ibge">IBGE:</label>
            </td>
            <td style="width: 16%;">
              <input type="text" [(ngModel)]="endereco.ibge"
                     class="form-control"
                     id="ibge"
                     name="ibgeFornecedor"
                     maxlength="100">
            </td>
            <td style="width: 12%;">
              <label for="gia">GIA:</label>
            </td>
            <td style="width: 20%;">
              <input type="text" [(ngModel)]="endereco.gia"
                     class="form-control"
                     id="gia"
                     name="giaFornecedor"
                     maxlength="100">
            </td>
          </tr>

          <!-- Linha 6: DDD, SIAFI -->
          <tr>
            <td style="width: 16%;">
              <label for="ddd">DDD:</label>
            </td>
            <td style="width: 24%;">
              <input type="text" [(ngModel)]="endereco.ddd"
                     class="form-control"
                     id="ddd"
                     name="dddFornecedor"
                     maxlength="100">
            </td>
            <td style="width: 12%;">
              <label for="siafi">SIAFI:</label>
            </td>
            <td colspan="3" style="width: 48%;">
              <input type="text" [(ngModel)]="endereco.siafi"
                     class="form-control"
                     id="siafi"
                     name="siafiFornecedor"
                     maxlength="100">
            </td>
          </tr>

          <!-- Linha 7: Aviso -->
          <tr>
            <td colspan="6" style="width: 100%;">
              <span style="font-size: 14px; color: red"><strong>AVISO: </strong></span> <span style="font-size: 13px;"> Busque pelo CEP e informe um Nome para finalizar o cadastro.</span>
            </td>
          </tr>

          <!-- Linha 8: Botão Cadastrar -->
          <tr>
            <td colspan="6" class="text-left" style="width: 100%;">
              <button type="submit" 
                      [disabled]="!fornecedorForm.form.valid || !cepBuscado" 
                      class="btn bg-primary-subtle fw-bold">
                Cadastrar
              </button>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </form>
    <!-- FIM FORMULÁRIO DE CADASTRO DE FORNECEDOR -->

<!-- Janela (modal) que abre depois de cadastrar um fornecedor -->
<ng-template #modalMsgAddFornecedor let-modal>
  <div class="modal-header">
    <h5 class="modal-title">
      Sucesso!
    </h5>
    <img ngSrc="/codigo_barras.png" height="60" width="60" class="img-right"/>
  </div>
  <div class="modal-body">
    <p>Fornecedor <b>ID: {{ novoFornecedor.id }} | Nome: {{ novoFornecedor.nome }}</b> cadastrado.</p>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.close()">Fechar</button>
  </div>
</ng-template>

<!-- Janela (modal) ERROS -->
<ng-template #modalMsgAviso let-modal>
  <div class="modal-header">
    <h5 class="modal-title">
      AVISO!
    </h5>
    <img ngSrc="/codigo_barras.png" height="60" width="60" class="img-right"/>
  </div>
  <div class="modal-body">
    <p>{{ mensagemErro }}</p>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.close()">Fechar</button>
  </div>
</ng-template>
    </div>
  </div>
</div>

<!-- Template alternativo quando dadosEmpresa for null -->
<div *ngIf="!dadosEmpresa && !informarCNPJ">
  <p class="text-muted">Dados da empresa não serão informados.</p>
</div>
